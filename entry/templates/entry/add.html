{% extends 'entry/base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-5 border p-3">
      <h5>Today's Entry</h5>
      <form id="add-form" method="post" action="">
        {% csrf_token %}
        <div class="form-group mb-3">
          <label class="form-label">Title</label>
          <input type="text" name="note" class="form-control" placeholder="Summarise the day" required>
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Content</label>
          <textarea name="content" rows="10" class="form-control" placeholder="Write your diary entry here" required></textarea>
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Productivity</label>
          <input type="range" name="productivity" min="0" max="10" value="5" step="1" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary w-100">Save & Create Card</button>
      </form>
    </div>

    <div class="col-md-2 d-flex align-items-center justify-content-center">
      <div id="progress-wrapper" class="w-100" style="display: none;">
        <div class="text-center mb-2">Generating image...</div>
        <div class="progress" style="height: 10px;">
          <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div class="col-md-5 border p-3">
      <h5>Four-cut Preview</h5>
      <div class="border mb-3 d-flex justify-content-center align-items-center" style="height: 400px;">
        <img id="preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 100%; display: none;" />
        <span id="preview-placeholder" class="text-muted">Preview</span>
      </div>
      <div class="d-flex justify-content-center flex-wrap gap-2">
        <button type="button" class="btn btn-outline-secondary" id="regenerate-btn" disabled>Regenerate</button>
        <button type="button" class="btn btn-primary" id="save-image-btn" disabled>Save</button>
        <a id="detail-link" class="btn btn-outline-secondary disabled" href="#" tabindex="-1" aria-disabled="true">View Details</a>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const progressWrapper = document.getElementById('progress-wrapper');
  const progressBar = document.getElementById('progress-bar');
  const previewImage = document.getElementById('preview-image');
  const previewPlaceholder = document.getElementById('preview-placeholder');
  const regenerateBtn = document.getElementById('regenerate-btn');
  const detailLink = document.getElementById('detail-link');
  const saveImageBtn = document.getElementById('save-image-btn');

  const NEW_DIARY_ID = {{ new_diary_id|default:'null' }};
  const generateUrlTemplate = `{% url 'generate_image' 0 %}`;
  const finalizeUrlTemplate = `{% url 'finalize_image' 0 %}`;
  let currentTempImageUrl = null;

  function disableDetailLink() {
    detailLink.classList.add('disabled');
    detailLink.href = '#';
    detailLink.setAttribute('tabindex', '-1');
    detailLink.setAttribute('aria-disabled', 'true');
  }

  function enableDetailLink(url) {
    detailLink.classList.remove('disabled');
    detailLink.href = url;
    detailLink.removeAttribute('tabindex');
    detailLink.removeAttribute('aria-disabled');
  }

  function animateProgressTo(target) {
    const current = parseInt(progressBar.style.width || '0', 10);
    const step = (target - current) / 30;
    let i = 0;
    const timer = setInterval(() => {
      i += 1;
      const next = Math.min(target, Math.round(current + step * i));
      progressBar.style.width = `${next}%`;
      if (next >= target || i >= 30) clearInterval(timer);
    }, 50);
  }

  async function startGeneration(id) {
    progressWrapper.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.classList.add('progress-bar-animated');
    regenerateBtn.disabled = true;
    saveImageBtn.disabled = true;
    disableDetailLink();
    previewImage.style.display = 'none';
    previewPlaceholder.style.display = 'block';
    currentTempImageUrl = null;
    animateProgressTo(90);

    try {
      const resp = await fetch(generateUrlTemplate.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') || '' }
      });
      const data = await resp.json();
      if (data.status === 'ok' && data.temp_image_url) {
        progressBar.classList.remove('progress-bar-animated');
        animateProgressTo(100);
        previewPlaceholder.style.display = 'none';
        previewImage.src = data.temp_image_url;
        previewImage.style.display = 'block';
        currentTempImageUrl = data.temp_image_url;
        regenerateBtn.disabled = false;
        saveImageBtn.disabled = false;
      } else {
        throw new Error(data.message || 'Failed to generate the image');
      }
    } catch (error) {
      console.error(error);
      progressWrapper.style.display = 'none';
      alert('An error occurred while generating the image. Please try again later.');
      regenerateBtn.disabled = false;
    }
  }

  async function finalizeImage(id) {
    if (!currentTempImageUrl) return;
    saveImageBtn.disabled = true;
    try {
      const resp = await fetch(finalizeUrlTemplate.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') || '' }
      });
      const data = await resp.json();
      if (data.status === 'ok') {
        currentTempImageUrl = null;
        if (data.image_url) {
          previewImage.src = data.image_url;
        }
        if (data.detail_url) {
          enableDetailLink(data.detail_url);
        }
      } else {
        throw new Error(data.message || 'Failed to save the image');
      }
    } catch (error) {
      console.error(error);
      alert('An error occurred while saving the image. Please try again.');
      saveImageBtn.disabled = false;
      return;
    }
  }

  disableDetailLink();

  if (NEW_DIARY_ID) {
    startGeneration(NEW_DIARY_ID);
  }

  if (regenerateBtn) {
    regenerateBtn.addEventListener('click', () => {
      if (!NEW_DIARY_ID) return;
      startGeneration(NEW_DIARY_ID);
    });
  }

  if (saveImageBtn) {
    saveImageBtn.addEventListener('click', () => {
      if (!NEW_DIARY_ID) return;
      finalizeImage(NEW_DIARY_ID);
    });
  }
</script>
{% endblock %}


